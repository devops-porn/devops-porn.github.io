<!doctype html><html class=no-js lang=fr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=siteBaseUrl content="https://devops-porn.fr/">
<meta name=author content="Dorian Boulc'h & Richard Leroux">
<meta name=description content="Blog ayant pour but de donner envie de pratiquer le DevOps. Peut potentiellement aider √† prendre plaisir √† faire de belles choses et √©ventuellement comme substitut au sexe.">
<meta name=keywords content="blog,devops,dev,d√©veloppement">
<meta name=generator content="Hugo 0.89.4">
<title>
Performances Symfony 5 sous Docker Desktop avec WSL2 | DevOps Porn
</title>
<meta name=description content="Performances Symfony 5 sous Docker Desktop avec WSL2 - Blog ayant pour but de donner envie de pratiquer le DevOps. Peut potentiellement aider √† prendre plaisir √† faire de belles choses et √©ventuellement comme substitut au sexe.">
<meta itemprop=name content="Performances Symfony 5 sous Docker Desktop avec WSL2">
<meta itemprop=description content="Performances Symfony 5 sous Docker Desktop avec WSL2 - Blog ayant pour but de donner envie de pratiquer le DevOps. Peut potentiellement aider √† prendre plaisir √† faire de belles choses et √©ventuellement comme substitut au sexe.">
<meta property="og:title" content="Performances Symfony 5 sous Docker Desktop avec WSL2">
<meta property="og:description" content="Performances Symfony 5 sous Docker Desktop avec WSL2 - Blog ayant pour but de donner envie de pratiquer le DevOps. Peut potentiellement aider √† prendre plaisir √† faire de belles choses et √©ventuellement comme substitut au sexe.">
<meta property="og:image" content="https://devops-porn.fr/article/wsl2-docker-symfony5/featuredImage_huc46a835af3b1bb04a0bf4f6f08ffb6ee_54784_700x350_fit_q95_box_3.png">
<meta property="og:url" content="https://devops-porn.fr/article/wsl2-docker-symfony5/">
<meta property="og:site_name" content="DevOps Porn">
<meta property="og:type" content="article"><meta property="fb:app_id" content="958375451364299"><meta property="og:image:width" content="512"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#2b5797">
<meta name=theme-color content="#ffffff">
<script src=/modernizr-simple.js></script>
<link href=/article/wsl2-docker-symfony5/ rel=alternate type=application/rss+xml title="DevOps Porn">
<link href=/article/wsl2-docker-symfony5/ rel=feed type=application/rss+xml title="DevOps Porn">
<link rel=canonical href=https://devops-porn.fr/article/wsl2-docker-symfony5/>
<link rel=preload href=https://devops-porn.fr/theme.css as=style>
<link rel=stylesheet href=https://devops-porn.fr/theme.css>
</head>
<body class=bilberry-hugo-theme>
<nav>
<div class=container>
<ul class=topnav>
</ul>
</div>
</nav>
<header>
<div class=container>
<div class=logo>
<a href=/ class=logo>
<img src=/logo.svg alt=Accueil>
</a>
</div>
<div class=titles>
<h3 class=title>
<a href=/>
DevOps Porn
</a>
</h3>
<span class=subtitle>Pratiquons le DevOps !</span>
</div>
</div>
</header>
<div class="main container">
<div class="article-wrapper u-cf single">
<a class=bubble href=https://devops-porn.fr/article/wsl2-docker-symfony5/>
<i class="fas fa-fw fa-pencil-alt"></i>
</a>
<article class="default article">
<div class=featured-image>
<a href=https://devops-porn.fr/article/wsl2-docker-symfony5/>
<img src=/article/wsl2-docker-symfony5/featuredImage_huc46a835af3b1bb04a0bf4f6f08ffb6ee_54784_1400x400_fill_q95_box_center_3.png alt="Article Performances Symfony 5 sous Docker Desktop avec WSL2">
</a>
</div>
<div class=content>
<h1 class=article-title>
<a href=https://devops-porn.fr/article/wsl2-docker-symfony5/>
Performances Symfony 5 sous Docker Desktop avec WSL2
</a>
</h1>
<div class=meta>
<span class="date moment">2020-05-30</span>
<span class=author>
<a href=https://devops-porn.fr/author/dorian/>Dorian</a>
</span>
</div>
<p>Aujourd&rsquo;hui, petit retour d&rsquo;exp√©rience sur la fonctionnalit√© <strong>WSL2 de Docker Desktop</strong>.</p>
<p>Docker Desktop depuis sa version <strong>2.3.0.2</strong> prend en charge <a href=https://docs.docker.com/docker-for-windows/wsl/><strong>WSL2</strong> comme backend</a>. Le but √©tant de remplacer le backend <strong>Hyper-V</strong> de base.<br>
Microsoft ayant bien int√©gr√© Linux via <a href=https://devblogs.microsoft.com/commandline/the-windows-subsystem-for-linux-build-2020-summary/>WSL2</a>, on peut d√©sormais disposer d&rsquo;un Linux sous Windows avec un <strong>partage du syst√®me de fichier</strong> et un <strong>partage r√©seau</strong> et tout √ßa en utilisant qu'<a href=https://docs.microsoft.com/fr-fr/windows/wsl/compare-versions#wsl-2-architecture>une toute petite machine virtuelle minimaliste</a>. De plus <a href=https://docs.microsoft.com/fr-fr/windows/wsl/wsl2-faq#does-wsl-2-use-hyper-v-will-it-be-available-on-windows-10-home>il n&rsquo;est <strong>plus n√©cessaire d&rsquo;avoir un Windows avec une license PRO</strong></a> qui √©tait un pr√©requis √† l&rsquo;installation du composant Hyper-V.</p>
<p>Tr√®s int√©ressant sur le papier, faisons quelques tests ! üòã</p>
<h2 id=activation-du-nouveau-backend>Activation du nouveau backend</h2>
<p>Plut√¥t simple, il suffit de cocher une case ! ‚òëÔ∏è<br>
<img src=/article/wsl2-docker-symfony5/wsl2-enabled.jpg alt=alt_text></p>
<p>On applique et tout roule comme sur des roulettes&mldr;</p>
<p><img src=/article/wsl2-docker-symfony5/wsl2-switching.jpg alt=alt_text></p>
<p>&mldr;Enfin presque ! √áa aura pour cons√©quence de repartir sur une <strong>base vierge</strong> de Docker. Autrement dit, il va falloir repuller un peu toutes vos images, recr√©er vos conteneurs etc&mldr;<br>
Rassurez-vous, si vous repassez sur le <strong>backend Hyper-V</strong>, toutes vos donn√©es sont conserv√©es.</p>
<h2 id=inspectons->Inspectons !</h2>
<p>Lan√ßons juste un serveur nginx avec un montage de volume.</p>
<p><code>PS > docker-compose up -d</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
<span style=color:#f92672>services</span>:
  <span style=color:#f92672>http</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>nginx</span>
    <span style=color:#f92672>ports</span>: 
      - <span style=color:#e6db74>&#34;80:80&#34;</span>
    <span style=color:#f92672>volume</span>:
      - <span style=color:#e6db74>&#34;./:/usr/share/nginx/html&#34;</span>
</code></pre></div><p>Observons le montage de volume !</p>
<p><code>PS > docker inspect nginx</code></p>
<p>Avec <strong>WSL2</strong> le point de montage se situe sur ce dossier :<br>
<em>/run/desktop/mnt/host/c/Users/dorian/workspace/tes_paupieres_sont_lourdes</em></p>
<p>Alors qu&rsquo;avec le backend <strong>Hyper-V</strong>, nous avions :
<em>/host_mnt/c/Users/dorian/workspace/tes_paupieres_sont_lourdes</em></p>
<p>On peut observer un <strong>changement du point de montage</strong> du dossier.<br>
Dans un cas, nous avions le dossier qui √©tait mont√© dans la <strong>VM faite par Docker</strong>, dans l&rsquo;autre sur le point de montage passant par la <strong>VM faite par Microsoft</strong>.<br>
Si on passe par la VM faite par Microsoft, on devrait b√©n√©ficier de <strong>meilleures performances d&rsquo;E/S</strong> d&rsquo;apr√®s ce qu&rsquo;ils d√©crivent dans <a href=https://docs.microsoft.com/fr-fr/windows/wsl/compare-versions#increased-file-io-performance>leur article</a>.</p>
<h2 id=symfonisons->Symfonisons !</h2>
<p>Pour information, chacun des tests suivants ont √©t√© ex√©cut√©s sur un m√™me <a href=https://www.corsair.com/fr/fr/Cat%C3%A9gories/Produits/Stockage/SSD-M-2/Force-Series-MP510/p/CSSD-F960GBMP510>disque SSD NVMe</a>.</p>
<h3 id=test-1-composer-install>Test #1: Composer install</h3>
<p>Lan√ßons un composer install sur un projet Symfony 5 vierge.
<code>PS > powershell -Command "Measure-Command {docker-compose run --rm composer install | Out-Default}"</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
<span style=color:#f92672>services</span>:
  <span style=color:#f92672>composer</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>composer</span>
    <span style=color:#f92672>volumes</span>: 
      - <span style=color:#e6db74>&#34;./:/app&#34;</span>
      - <span style=color:#e6db74>&#34;composer_home:/tmp&#34;</span>
<span style=color:#f92672>volumes</span>:
  <span style=color:#f92672>composer_home</span>:
</code></pre></div><p>On ex√©cute la commande une premi√®re fois pour t√©l√©charger les d√©pendances dans le dossier de cache de composer afin d&rsquo;√©viter les √©ventuelles variations de bande passante.<br>
Puis on supprime les dossiers pour recommencer :<br>
<code>rm -rf vendor</code><br>
<code>rm -rf var/cache</code></p>
<p>Et Voici le r√©sultat pour WSL2 : <strong>3m52s</strong><br>
Et avec Hyper-V : <strong>2m3s</strong></p>
<p>üòÆ Oui oui, vous avez-bien lu, la VM de Docker est plus performante que celle de Microsoft&mldr; Soit une <strong>augmentation de 88%</strong> du temps.</p>
<p>Activons Docker Desktop pour mon Ubuntu tournant sous WSL2 !</p>
<p><img src=/article/wsl2-docker-symfony5/wsl-ubuntu-distro.jpg alt=alt_text></p>
<p>R√©essayons d&rsquo;ex√©cuter cette commande dans le bash de mon Ubuntu cette fois-ci :
<code>$ time docker-compose run --rm composer install</code></p>
<p>Cette fois-ci, le point de montage du volume n&rsquo;est pas au m√™me endroit.
<em>/run/desktop/mnt/host/wsl/docker-desktop-bind-mounts/Ubuntu/zae684grt65432dsq98eza69584a</em></p>
<p>R√©sultat : <strong>3m48</strong><br>
On retrouve similairement la m√™me chose qu&rsquo;avec PowerShell.</p>
<p>Tentons une derni√®re exp√©rience üòÄ !<br>
Utilisation de docker <strong>exclusivement dans Ubuntu</strong>. Cette fois-ci, il n&rsquo;y a pas de montage d&rsquo;un volume mont√© dans la VM.
<code>$ time docker-compose run --rm composer install</code></p>
<p>R√©sultat : <strong>5s</strong></p>
<p>Cette fois-ci nous obtenons un r√©sultat <strong>plus que satisfaisant</strong> üéâ ! Mais les sources sont c√¥t√© Linux.<br>
Pour pouvoir y acc√©der, un <strong>partage r√©seau</strong> est directement activ√© via : <code>\\wsl$\Ubuntu\home\dorian\workspace</code><br>
Mais dans ce cas c&rsquo;est l'<strong>IDE</strong> ou ce que vous faites c√¥t√© Windows qui <strong>risque d&rsquo;√™tre ralenti</strong>&mldr; üêå</p>
<p>R√©capitulons, pour un <code>composer install</code> :</p>
<figure><a href=composer-graph.svg><img src=composer-graph.jpg></a>
</figure>
<h3 id=test-2-affichage-de-la-page-daccueil>Test #2: Affichage de la page d&rsquo;accueil</h3>
<p>Lan√ßons simplement le site dans un conteneur <code>php:7.4-apache</code>.<br>
On supprime le cache de symfony <code>rm -rf var/cache</code><br>
On acc√®de √† <a href=http://localhost>http://localhost</a> une premi√®re fois pour analyser le temps d&rsquo;initialisation du cache et une seconde une fois que le cache est initialis√©.<br>
Sur les comparatifs suivants, la couleur orange repr√©sente le temps d&rsquo;initialisation de Symfony.</p>
<h4 id=cache-non-initialis√©>Cache non initialis√©</h4>
<p><figure><a href=/article/wsl2-docker-symfony5/sf-no-cache-graph.svg><img src=/article/wsl2-docker-symfony5/sf-no-cache-graph.jpg></a>
</figure>
Screenshots :</p>
<ul>
<li>Volume mont√©
<ul>
<li><a href=/article/wsl2-docker-symfony5/symfony5-home-page-perf-wsl2-mount-without-cache.jpg>WSL2 </a></li>
<li><a href=/article/wsl2-docker-symfony5/symfony5-home-page-perf-hyperv-mount-without-cache.jpg>Hyper-V</a></li>
</ul>
</li>
<li>Volume non mont√©
<ul>
<li><a href=/article/wsl2-docker-symfony5/symfony5-home-page-perf-wsl2-without-cache.jpg>WSL2</a></li>
</ul>
</li>
</ul>
<h4 id=cache-initialis√©>Cache initialis√©</h4>
<p><figure><a href=/article/wsl2-docker-symfony5/sf-cache-graph.svg><img src=/article/wsl2-docker-symfony5/sf-cache-graph.jpg></a>
</figure>
Screenshots :</p>
<ul>
<li>Volume mont√©
<ul>
<li><a href=/article/wsl2-docker-symfony5/symfony5-home-page-perf-wsl2-mount-with-cache.jpg>WSL2 </a></li>
<li><a href=/article/wsl2-docker-symfony5/symfony5-home-page-perf-hyperv-mount-with-cache.jpg>Hyper-V</a></li>
</ul>
</li>
<li>Volume non mont√©
<ul>
<li><a href=/article/wsl2-docker-symfony5/symfony5-home-page-perf-wsl2-with-cache.jpg>WSL2</a></li>
</ul>
</li>
</ul>
<p>On constate de <strong>tr√®s mauvaises performances</strong> dans le cas o√π on monte un volume et qu&rsquo;on utilise WSL2.<br>
Le backend Hyper-v reste comp√©titif m√™me si il prend tout de m√™me pas loin de <strong>deux fois plus de temps</strong> √† charger que WSL2 contenant les sources directement dans la VM.</p>
<h2 id=alors-doit-on-lactiver->Alors, doit-on l&rsquo;activer ?</h2>
<h3 id=ce-qui-est-bien->Ce qui est bien !</h3>
<ul>
<li>Les <strong>performances sont bien sup√©rieures</strong> lorsqu&rsquo;on ne monte pas un dossier de Windows vers la VM de WSL2.<br>
On pourrait envisager de <strong>d√©placer enti√®rement son dossier workspace</strong> dans notre WSL, ce qui pourrait augmenter massivement les performances.</li>
<li>Nous &ldquo;r√©cup√©rons&rdquo; le <strong>syst√®me de permissions</strong> sur les fichiers de Linux. Cela permettrait d&rsquo;√©carter rapidement des probl√®mes qui pourraient survenir qu&rsquo;√† la livraison.</li>
<li>Nous avons toujours le binding des ports sur la machine h√¥te. On peut toujours acc√©der √† nos applications via localhost m√™me si les services tournent dans la VM de WSL2.</li>
</ul>
<h3 id=ce-qui-est-moins-bien>Ce qui est moins bien</h3>
<ul>
<li>L&rsquo;indexation des IDE va gal√©rer&mldr; Mais ce n&rsquo;est pas quelque chose qui va s&rsquo;ex√©cuter toutes les secondes non plus!</li>
<li>La consommation de RAM est plut√¥t augment√©e. Le backend Hyper-V limitait de base la consommation de RAM √† 2Go. Cette fois-ci il va falloir surveiller plus en d√©tail car il peut consommer jusqu&rsquo;√† 80% de votre RAM.<br>
Il existe un <a href=https://docs.microsoft.com/en-us/windows/wsl/wsl-config#configure-global-options-with-wslconfig>workaround pour limiter la consommation de RAM de la VM</a></li>
</ul>
<p>Je pense donc que le temps sacrifi√© √† attendre que son IDE indexe sont projet sera <strong>inf√©rieur au temps pass√© √† attendre que les pages se chargent</strong> ou qu&rsquo;un composer install se termine. Malgr√© tout, l&rsquo;utilisation d&rsquo;autres outils graphique (comme Gitkraken) pour g√©rer les repos GIT sont <strong>nettement impact√©s</strong>. Comme <a href=https://www.docker.com/blog/docker-desktop-wsl-2-best-practices/>indiqu√© dans l&rsquo;article de Simon Ferquel</a>, il sera bient√¥t possible d'<strong>ex√©cuter des programmes avec une interface graphique directement dans WSL2</strong> ce qui permettra de profiter de toutes les performances du Linux ! Mais attendez&mldr; Pourquoi ne pas installer Linux directement si c&rsquo;est si bien ..? Ceci est un autre d√©bat !</p>
<p>Dans tous les cas, √† mon avis, <strong>OUI ! Il faut l&rsquo;essayer</strong>. Pas d&rsquo;inqui√©tude, si √ßa ne fonctionne plus, il vous suffira de d√©cocher la case et vous repasserez sur le backend Hyper-V en un clin d&rsquo;≈ìil üòâ.</p>
</div>
<div class=footer>
<div class=tags>
<i class="fa fa-tags"></i>
<div class=links>
<a href=https://devops-porn.fr/tags/docker/>Docker</a>
<a href=https://devops-porn.fr/tags/symfony-5/>Symfony 5</a>
<a href=https://devops-porn.fr/tags/wsl2/>WSL2</a>
<a href=https://devops-porn.fr/tags/windows/>Windows</a>
</div>
</div>
</div>
</article>
</div>
<div id=comments-container>
</div>
</div>
<footer>
<div class=container>
<div class=recent-posts>
<strong>Derniers articles</strong>
<ul>
<li>
<a href=https://devops-porn.fr/article/intro-gpg/>Communiquons de fa√ßon s√©curis√©e avec GPG</a>
</li>
<li>
<a href=https://devops-porn.fr/article/git-config-pro-perso/>Ne plus se tromper de profil Git !</a>
</li>
<li>
<a href=https://devops-porn.fr/article/wsl-2-wut/>WSL wut ?</a>
</li>
<li>
<a href=https://devops-porn.fr/article/wsl2-docker-symfony5/>Performances Symfony 5 sous Docker Desktop avec WSL2</a>
</li>
</ul>
</div>
<div class=right>
<div class=archive>
<a href=/archive/><strong>Archive</strong></a>
</div>
</div>
</div>
</footer>
<div class=credits>
<div class=container>
<div class=copyright>
<a href=https://github.com/devops-porn/ target=_blank rel=noreferrer>
&copy;
2021
by a DevOps team
</a>
</div>
</div>
</div>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-169407142-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-169407142-1')</script>
</body>
</html>